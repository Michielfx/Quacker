<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>XFactor</title>

<link rel="stylesheet" href="/style/theme.css"/>
<link rel="stylesheet" href="/style/backoffice.min.css"/>
<link rel="stylesheet" href="/style/sass/xfactor.css"/>

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script> -->
<script src="/lib/Chart.bundle.min.js"></script>


<!-- <script src="/lib/jquery-2.1.1.min.js"></script> OLD JQuery-->

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> Flot might not work with this version of jquery -->
<script src="/lib/jquery-3.4.1.min.js"></script> <!--Flot might not work with this version of jquery-->


<!-- <script src="/lib/jquery.flot.min.js"></script> -->
<!-- <script src="/lib/core.js"></script> -->
<!-- <script src="/lib/charts.js"></script> -->
<!-- <script src="/lib/log.js"></script> -->
<!-- <script src="/lib/tweets.js"></script> -->

</head>
<body class="xdash">

    <div class="xfactor-header">
        <h1>X</h1>
    </div>

    <div class="pop-account-container">
        <ol id="pop-account-list"></ol>
    </div>

    <div class="left-container">
        <div class="tweet-list-container">
            <ol id="tweetlist" class="tweet-list">

            </ol>
        </div>        
        <input class="tweet-input" placeholder="  Tweet!" type="text"/>
    </div>
        
    <div class="positivity-container">
        <canvas class="positivity-canvas" height="100%" width="100%" id="posCanvas"></canvas>
    </div>

    <div class="pop-country-container">
            
    </div>
        
<!-- Popularity Chart -->


<!-- Uni Tweet Formatters -->
<script>
// Entity formatters for use by tweet list
var entity_formatters = {
    'urls': function(e) {
        return '<a href="' + e.url + '">' + e.display_url + '</a>';
    },
    
    'user_mentions': function(e) {
        return '<a href="https://twitter.com/'+e.screen_name+'">@'+e.screen_name+'</a>';
    },

    'hashtags': function(e) {
        return '<a href="https://twitter.com/hashtag/'+e.text+'?src=hash">#' +e.text+'</a>';
    },

    'default': function(e) {
        return '{ENTITY}';
    }
};

// processes entities for the given message and entity object
var process_entities = function(message, entities) {
    // short-circuit failure mode
    if(typeof entities === 'undefined') {
        return message;
    }

    // build list of entities sorted on starting index
    var es = [];

    $.each(entities, function(t, ts) {
        $.each(ts, function(_, e) {
            e['type'] = t;
            es.push(e);
        });
    });

    es.sort(function(a,b) {
        return a['indices'][0] - b['indices'][0];
    });

    // process entities one-by-one in order of appearance
    var marker = 0;
    var result = "";
    for(var i in es) {
        var e = es[i];
        var start = e['indices'][0];
        var stop = e['indices'][1];

        //copy string content
        result += message.substring(marker, start);

        //process entity (through formatter or no-op function)
        var formatter = entity_formatters[e.type]
                        || function(e) { return message.substring(start,stop) };
        result += formatter(e);

        // update marker location
        marker = stop;
    }

    // append tail of message
    result += message.substring(marker, message.length);

    return result;
}
</script>

<!-- Tweets -->
<script>

// create the necessary HTML in the block container
// $('#tweets').append('<ol id="tweetlist" class="tweet-list stream-items"></ol>');

    var e = new EventSource('/events');
    e.addEventListener('tweets', function(m) {
        // console.exception("Received malformed message: ");

            try {
                var tweet = JSON.parse(m.data);
            } catch(err) {
                console.exception("Received malformed message: ", err);
                return;
            }

            var $account = $('<a class="account-group"></a>');
            $account.attr("href", "http://twitter.com/" + tweet.user.screen_name);

            var $avatar = $("<img>").addClass("avatar");
            // $avatar.attr("src", tweet.user.profile_image_url);
            $account.append($avatar);
            $account.append($('<strong class="fullname">' + tweet.user.name + '</strong>'));
            $account.append($('<span>&nbsp;</span>'));
            $account.append($('<span class="username"><s>@</s><b>' + tweet.user.screen_name + '</b></span>'));

            var $time = $('<small class="time"></small>');
            $time.append($('<span>' + tweet.created_at + '</span>'));

            // Build contents:
            var text = process_entities(tweet.text, tweet.entities);
            var $text = $('<p class="tweet-text">' + text + '</p>');

            var item = `
            <li class="stream-item">
                <div class="tweet">
                    <div class="content">
                        <div class="stream-item-header">
                            ${$account.html()}
                            <small class="time"><span>${$time.html()}</span></small>
                        </div>
                        <p class="tweet-text">${$text.html()}</p>
                    </div>
                </div>
            </li>`;

            var list = $('#tweetlist');
            // place new tweet in front of list 
            list.prepend(item);

            // remove stale tweets
            if (list.children().length > 20) {
                list.children().last().remove();
            }
        });
    
</script>

<script>
        var ctx = document.getElementById('posCanvas').getContext('2d');
        var color = Chart.helpers.color;
        var fill = ctx.createPattern
        $(document).ready(function (){
            var popData = {
                labels: ["Positivity"],

                datasets: [
                    {
                        label: "Negative",
                        backgroundColor: "rgba(200, 40, 40, 0.5)",
                        borderColor: "rgba(200, 40, 40, 1)",
                        borderWidth: 1,
                        data: [-0.2]
                        // barThickness: 6,
                        // maxBarThickness: 6
                    }
                    ,
                    {
                        label: "Positive",
                        backgroundColor: "rgba(40, 200, 40, 0.5)",
                        borderColor: "rgba(40, 200, 40, 1)",
                        borderWidth: 1,
                        data: [0.8]
                        // barThickness: 6,
                        // maxBarThickness: 6
                    }
                ]
            }
    
            let popChart = new Chart(ctx, {
                type: 'bar',
                data: popData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: {
                        display: false,
                        position: 'top'
                    },
                    title: {
                        display: false,

                    },
                    scales: {
                        yAxes: [{
                            display: false,
                            ticks:{
                                suggestedMin: -1,
                                suggestedMax: 1
                            }
                        }],
                        xAxes: [{
                            display: false,
                            stacked: true
                        }]
                    }
                }
            });

            e.addEventListener('mood', function(d) {
                try {
                    var m = JSON.parse(d.data);
                } catch(err) {
                    console.exception("Received malformed message: ", err);
                    return;
                }

                popChart.data.datasets[0].data[0] = -m.mood_value[0];
                popChart.data.datasets[1].data[0] = m.mood_value[1];
                popChart.update();
            });
        });
        
        
    
    </script>


<!-- Tweets -->
<script>

    // create the necessary HTML in the block container
    // $('#tweets').append('<ol id="tweetlist" class="tweet-list stream-items"></ol>');
    
        // var e = new EventSource('/events');
        e.addEventListener('account', function(d) {
            try {
                    var m = JSON.parse(d.data);
                } catch(err) {
                    console.exception("Received malformed message: ", err);
                    return;
            }


            // var listEl = $('#pop-account-list');
            // listEl.empty();
            // m.value.forEach((account) => {
            //     listEl.append(`<li class="pop-account-item"><a class="pop-account-link" href="https://twitter.com/${account[0]}">${account[0]}</a></li>`);
            //     listEl.append('<hr/>');
            // });
            
            var listEl = $('#pop-account-list');
            listEl.empty();
            for (let index = 0; index < m.value.length; index++) {
                listEl.append(`<li class="pop-account-item"><a class="pop-account-link" href="https://twitter.com/${m.value[index][0]}">${index + 1}. ${m.value[index][0]}</a></li>`);
                if(index != m.value.length - 1){
                    listEl.append('<hr/>');
                }
            }

        });
        
    </script>

</body>
</html>
